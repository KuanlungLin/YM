<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Merge Cost Sheets from VC Download</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #F5F1E9;
            color: #2C3E50;
            text-align: center;
            padding: 40px;
            margin: 0;
        }
        h1 {
            color: #8B4513;
            margin-bottom: 20px;
        }
        .container {
            background-color: #FFFFFF;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        input[type="file"], button {
            display: block;
            margin: 15px auto;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        input[type="file"] {
            background-color: #D2B48C;
            color: #2C3E50;
            cursor: pointer;
        }
        button {
            background-color: #2C3E50;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #34495E;
        }
        button:disabled {
            background-color: #A9A9A9; /* 反灰色 */
            cursor: not-allowed;
        }
        #clearBtn {
            background-color: #8B4513;
        }
        #clearBtn:hover:not(:disabled) {
            background-color: #A0522D;
        }
        #fileList, #status {
            margin-top: 20px;
            color: #2C3E50;
            font-size: 14px;
        }
        #fileList ul {
            list-style: none;
            padding: 0;
        }
        #fileList li {
            background-color: #ECE5DD;
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #fileList li button {
            background-color: #A0522D;
            padding: 5px 10px;
            font-size: 12px;
            margin: 0;
        }
        #fileList li button:hover:not(:disabled) {
            background-color: #CD5C5C;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Merge Cost Sheets from VC Download</h1>
        <input type="file" id="csvFiles" multiple accept=".csv" onchange="updateFileList()">
        <button id="processBtn" onclick="processFiles()" disabled>Process and Download</button>
        <button id="clearBtn" onclick="clearFiles()">Clear All Files</button>
        <div id="fileList"></div>
        <p id="status"></p>
    </div>

    <script>
        let uploadedFiles = []; // 儲存已上傳的檔案

        function updateFileList() {
            const files = document.getElementById('csvFiles').files;
            if (files.length > 0) {
                uploadedFiles = uploadedFiles.concat(Array.from(files)); // 追加新檔案
                document.getElementById('csvFiles').value = ''; // 清空輸入框
            }
            displayFileNames();
            toggleProcessButton();
        }

        function displayFileNames() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = uploadedFiles.length > 0 ?
                `<h3>Uploaded Files:</h3><ul>` + 
                uploadedFiles.map((file, index) => 
                    `<li>${file.name} <button onclick="deleteFile(${index})">Delete</button></li>`
                ).join('') + '</ul>' : '';
        }

        function clearFiles() {
            uploadedFiles = [];
            document.getElementById('csvFiles').value = '';
            displayFileNames();
            document.getElementById('status').textContent = '';
            toggleProcessButton();
        }

        function deleteFile(index) {
            uploadedFiles.splice(index, 1); // 移除指定檔案
            displayFileNames();
            toggleProcessButton();
        }

        function toggleProcessButton() {
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = uploadedFiles.length === 0; // 根據檔案數量啟用/禁用
        }

        function processFiles() {
            const status = document.getElementById('status');
            status.textContent = "Processing...";

            if (uploadedFiles.length === 0) {
                alert("Please select at least one CSV file!");
                status.textContent = "";
                return;
            }

            let allData = [];
            let maxColumns = 0;
            let firstFileHeaders = [];

            function processFile(file, index, callback) {
                Papa.parse(file, {
                    complete: function(result) {
                        const lines = result.data;
                        if (lines.length < 2) {
                            callback([]);
                            return;
                        }

                        const headers = lines.slice(0, 2);
                        const data = lines.slice(2);

                        headers.forEach(row => {
                            maxColumns = Math.max(maxColumns, row.length);
                            if (index === 0) firstFileHeaders.push(row);
                        });
                        data.forEach(row => {
                            maxColumns = Math.max(maxColumns, row.length);
                        });

                        callback(data);
                    },
                    skipEmptyLines: true,
                    encoding: "UTF-8"
                });
            }

            let processedFiles = 0;
            for (let i = 0; i < uploadedFiles.length; i++) {
                processFile(uploadedFiles[i], i, (fileData) => {
                    allData = allData.concat(fileData);
                    processedFiles++;

                    if (processedFiles === uploadedFiles.length) {
                        const normalizedHeaders = firstFileHeaders.map(header => {
                            if (header.length < maxColumns) {
                                return header.concat(Array(maxColumns - header.length).fill(''));
                            } else if (header.length > maxColumns) {
                                return header.slice(0, maxColumns);
                            }
                            return header;
                        });

                        const normalizedData = allData.map(row => {
                            if (row.length < maxColumns) {
                                return row.concat(Array(maxColumns - row.length).fill(''));
                            } else if (row.length > maxColumns) {
                                return row.slice(0, maxColumns);
                            }
                            return row;
                        });

                        const finalData = normalizedHeaders.concat(normalizedData);

                        const fileName = prompt("Please enter the download file name (without extension):", "merged_cost_sheets");
                        if (fileName === null) {
                            status.textContent = "Download canceled";
                            return;
                        }
                        const finalFileName = fileName.trim() ? `${fileName}.xlsx` : "merged_cost_sheets.xlsx";

                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.aoa_to_sheet(finalData);
                        XLSX.utils.book_append_sheet(wb, ws, "Merged");
                        XLSX.writeFile(wb, finalFileName);

                        status.textContent = `Processing complete, file downloaded: ${finalFileName}`;
                    }
                });
            }
        }
    </script>
</body>
</html>