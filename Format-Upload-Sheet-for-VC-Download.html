<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Format Upload Sheet for VC Download</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #F5F1E9;
            color: #2C3E50;
            text-align: center;
            padding: 40px;
            margin: 0;
        }
        h1 {
            color: #8B4513;
            margin-bottom: 20px;
        }
        .container {
            background-color: #FFFFFF;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }
        input[type="file"] {
            display: block;
            margin: 15px auto;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            background-color: #D2B48C;
            color: #2C3E50;
            cursor: pointer;
        }
        .button-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 30px 0 15px 0;
        }
        .ports-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .or-text {
            color: #808080;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            background-color: #2C3E50;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #34495E;
        }
        button:disabled {
            background-color: #A9A9A9;
            cursor: not-allowed;
        }
        #clearAllBtn, #clearSelection, #savePortsBtn {
            background-color: #8B4513;
        }
        #clearAllBtn:hover:not(:disabled), #clearSelection:hover:not(:disabled), #savePortsBtn:hover:not(:disabled) {
            background-color: #A0522D;
        }
        #clearPortsBtn {
            background-color: #A9A9A9;
        }
        #clearPortsBtn:not(:disabled) {
            background-color: #8B4513;
        }
        #clearPortsBtn:not(:disabled):hover {
            background-color: #A0522D;
        }
        #fileList {
            margin-top: 20px;
            color: #2C3E50;
            font-size: 16px;
            font-weight: bold;
        }
        #portsStatus {
            margin-top: 20px;
            color: #2C3E50;
            font-size: 14px;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            background-color: #F0E6D2;
            border: 2px solid #8B4513;
            border-radius: 5px;
            color: #2C3E50;
            font-size: 16px;
            font-weight: bold;
            display: none;
        }
        #langSwitch {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        #langSwitch select, #reeferInput {
            padding: 5px;
            border-radius: 5px;
            background-color: #F0E6D2;
            color: #2C3E50;
            border: none;
        }
        #repoDateInput {
            background-color: #F0E6D2;
            color: #2C3E50;
            width: 120px;
        }
        .input-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
            position: relative;
        }
        .input-row label {
            margin-right: 10px;
            font-size: 16px;
        }
        .input-row label .date-format {
            font-size: 12px;
            color: #808080;
        }
        #repoDateInput.error {
            border: 2px solid #FF0000;
        }
        #dateError {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            color: #FF0000;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        #filterModal, #portsModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #FFFFFF;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .filter-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin: 15px 0;
        }
        .filter-section {
            flex: 0 1 45%;
        }
        .filter-section h3 {
            margin-bottom: 5px;
            font-size: 18px;
            text-align: left;
        }
        .filter-section .subtitle {
            font-size: 14px;
            color: #2C3E50;
            line-height: 1.2;
            text-align: left;
            margin-bottom: 15px;
        }
        .filter-options {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #D2B48C;
            padding: 10px;
            border-radius: 5px;
            background-color: #F0E6D2;
            text-align: left;
        }
        .filter-options label {
            display: block;
            margin: 5px 0 5px 0;
            color: #2C3E50;
        }
        #rowCount {
            margin: 15px 0;
            font-size: 18px;
            color: #8B4513;
        }
        #clearSelection, #savePortsBtn {
            margin-top: 10px;
        }
        #portsTable {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        #portsTable th, #portsTable td {
            border: 1px solid #D2B48C;
            padding: 8px;
            text-align: left;
        }
        #portsTable th {
            background-color: #F0E6D2;
        }
        #portsTable input {
            width: 100%;
            border: none;
            background: transparent;
            color: #2C3E50;
        }
        #portsTable .error {
            background-color: #FFDCDC;
        }
        .help-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
            cursor: pointer;
        }
        .help-tooltip {
            display: none;
            position: absolute;
            top: 30px;
            right: 0;
            background-color: #FFF;
            border: 1px solid #D2B48C;
            padding: 10px;
            width: 300px;
            text-align: left;
            font-size: 14px;
            color: #2C3E50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .help-icon:hover + .help-tooltip {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="langSwitch">
            <select id="language" onchange="changeLanguage()">
                <option value="en">English</option>
            </select>
        </div>
        <h1 id="title">Format Upload Sheet for VC Download</h1>
        <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="updateFileList()">
        <div class="ports-row">
            <button id="portsBtn" onclick="showPortsModal()" disabled>Insert Extra Ports</button>
            <button id="clearPortsBtn" onclick="clearPorts()" disabled>Clear Extra Ports</button>
        </div>
        <div class="input-row">
            <label id="reeferLabel" for="reeferInput">Reefer:</label>
            <select id="reeferInput">
                <option value="N" selected>N</option>
                <option value="Y">Y</option>
            </select>
        </div>
        <div class="input-row">
            <label id="repoDateLabel" for="repoDateInput">Repo Eff Date <span class="date-format">(YYYY.MM.DD)</span>:</label>
            <input type="text" id="repoDateInput" maxlength="10" placeholder="e.g., 2025.02.26">
            <div id="dateError"></div>
        </div>
        <div class="button-row">
            <button id="downloadBtn" onclick="processAndDownload()">Download Directly</button>
            <span class="or-text" id="orText">or</span>
            <button id="filterBtn" onclick="showFilterModal()">Filter Data</button>
        </div>
        <button id="clearAllBtn" onclick="clearFile()" style="background-color: #A52A2A;" onmouseover="this.style.backgroundColor='#8B1A1A'" onmouseout="this.style.backgroundColor='#A52A2A'">Clear All</button>
        <div id="fileList"></div>
        <div id="portsStatus"></div>
        <div id="status"></div>
    </div>

    <div id="filterModal">
        <div class="modal-content">
            <h2 id="filterTitle">Filter Data</h2>
            <div class="filter-container">
                <div class="filter-section">
                    <h3 id="originLabel">Filter by Origin <span id="originReq"></span></h3>
                    <div class="subtitle" id="originSubtitle">Multiple Selection Allowed<br>Select at Least One</div>
                    <div id="fromFilter" class="filter-options"></div>
                </div>
                <div class="filter-section">
                    <h3 id="destLabel">Filter by Destination <span id="destOpt"></span></h3>
                    <div class="subtitle" id="destSubtitle">Multiple Selection Allowed<br>Select All by Default if None Chosen</div>
                    <div id="toFilter" class="filter-options"></div>
                </div>
            </div>
            <div id="rowCount"></div>
            <button id="clearSelection" onclick="clearSelection()">Clear Selection</button>
            <button id="downloadFilteredBtn" onclick="applyFilterAndDownload()">Download Filtered Data</button>
            <button id="cancelBtn" onclick="closeModal('filterModal')">Cancel</button>
        </div>
    </div>

    <div id="portsModal">
        <div class="modal-content">
            <h2>Insert Extra Ports</h2>
            <span class="help-icon">?</span>
            <div class="help-tooltip">
                You can manually enter From and To values (5 characters, uppercase letters or numbers only) or upload an XLSX/XLS file (max 30 rows, excluding header).<br>
                - If From is empty, unique From values from the main file will be used.<br>
                - If To is empty, unique To values from the main file will be used.<br>
                - If both From and To are provided, combinations will be generated.<br>
                - Uploaded values will overwrite manually entered values if confirmed.<br>
                - Values are only saved when you click Save Ports. If any value has an invalid format, Save Ports will be disabled.<br>
                - Invalid values will be highlighted in red.
            </div>
            <input type="file" id="portsFile" accept=".xlsx, .xls" onchange="loadPortsFile()">
            <table id="portsTable">
                <thead>
                    <tr>
                        <th>From</th>
                        <th>To</th>
                    </tr>
                </thead>
                <tbody id="portsTableBody"></tbody>
            </table>
            <button id="savePortsBtn" onclick="savePorts()">Save Ports</button>
            <button onclick="closeModal('portsModal')">Cancel</button>
        </div>
    </div>

    <script>
        const translations = {
            "en": {
                "downloadBtn": "Download Directly",
                "orText": "or",
                "filterBtn": "Filter Data",
                "clearBtn": "Clear All",
                "fileListTitle": "Uploaded File:",
                "noFileAlert": "Please select an Excel (.xlsx) file!",
                "processing": "Processing...",
                "complete": "Processing complete, file downloaded: ",
                "invalidDateAlert": "Please enter a valid date in YYYY.MM.DD format!",
                "filterTitle": "Filter Data",
                "originReq": "(Required)",
                "originSubtitle": "Multiple Selection Allowed<br>Select at Least One",
                "destOpt": "(Optional)",
                "destSubtitle": "Multiple Selection Allowed<br>Select All by Default if None Chosen",
                "rowCount": "Selected rows: ",
                "clearSelection": "Clear Selection",
                "downloadFilteredBtn": "Download Filtered Data",
                "cancelBtn": "Cancel",
                "rowLimitAlert": "Selected rows exceed 500! Please reduce your selection.",
                "originAlert": "Please select at least one value from the 'Origin' column!",
                "portsBtn": "Insert Extra Ports",
                "savePortsBtn": "Save Ports",
                "clearPortsBtn": "Clear Extra Ports",
                "portsStatusEmpty": "Insert Extra Ports: No values added",
                "portsStatusFilled": "Insert Extra Ports: Values added",
                "portsUploadLimitAlert": "Uploaded file exceeds 30 rows (excluding header). Only the first 30 rows will be used.",
                "portsUploadOverwriteConfirm": "You have manually entered values. Uploading a file will overwrite them. Proceed?",
                "portsFormatError": "Invalid format at row {row}: {value}. Must be 5 characters (uppercase letters or numbers only).",
                "portsInvalidFormatAlert": "Cannot save due to invalid format in one or more fields. Values must be 5 characters (uppercase letters or numbers only).",
                "dateFormatError": "Invalid date",
                "dateRangeError": "Invalid date"
            }
        };

        let currentLang = "en";
        let uploadedFile = null;
        let processedData = null;
        let portsData = Array(30).fill().map(() => ['', '']);
        let savedPortsData = Array(30).fill().map(() => ['', '']);

        function changeLanguage() {
            currentLang = document.getElementById('language').value;
            document.getElementById('downloadBtn').textContent = translations[currentLang].downloadBtn;
            document.getElementById('orText').textContent = translations[currentLang].orText;
            document.getElementById('filterBtn').textContent = translations[currentLang].filterBtn;
            document.getElementById('portsBtn').textContent = translations[currentLang].portsBtn;
            document.getElementById('clearPortsBtn').textContent = translations[currentLang].clearPortsBtn;
            document.getElementById('clearAllBtn').textContent = translations[currentLang].clearBtn;
            document.getElementById('filterTitle').textContent = translations[currentLang].filterTitle;
            document.getElementById('originReq').textContent = translations[currentLang].originReq;
            document.getElementById('originSubtitle').innerHTML = translations[currentLang].originSubtitle;
            document.getElementById('destOpt').textContent = translations[currentLang].destOpt;
            document.getElementById('destSubtitle').innerHTML = translations[currentLang].destSubtitle;
            document.getElementById('clearSelection').textContent = translations[currentLang].clearSelection;
            document.getElementById('downloadFilteredBtn').textContent = translations[currentLang].downloadFilteredBtn;
            document.getElementById('cancelBtn').textContent = translations[currentLang].cancelBtn;
            document.getElementById('savePortsBtn').textContent = translations[currentLang].savePortsBtn;
            displayFileName();
            updatePortsStatus();
            updateRowCount();
        }

        function updateFileList() {
            const file = document.getElementById('excelFile').files[0];
            if (file) {
                uploadedFile = file;
                displayFileName();
                document.getElementById('portsBtn').disabled = false;
            } else {
                document.getElementById('portsBtn').disabled = true;
                document.getElementById('clearPortsBtn').disabled = true;
            }
            updatePortsStatus();
        }

        function displayFileName() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = uploadedFile ?
                `<h3>${translations[currentLang].fileListTitle}</h3><p>${uploadedFile.name}</p>` : '';
        }

        function updatePortsStatus() {
            const portsStatus = document.getElementById('portsStatus');
            const hasValues = savedPortsData.some(row => row[0] || row[1]);
            portsStatus.textContent = hasValues ?
                translations[currentLang].portsStatusFilled :
                translations[currentLang].portsStatusEmpty;
            document.getElementById('clearPortsBtn').disabled = !hasValues || !uploadedFile;
            document.getElementById('portsBtn').disabled = !uploadedFile;
        }

        function clearFile() {
            uploadedFile = null;
            portsData = Array(30).fill().map(() => ['', '']);
            savedPortsData = Array(30).fill().map(() => ['', '']);
            document.getElementById('excelFile').value = '';
            document.getElementById('reeferInput').value = 'N';
            document.getElementById('repoDateInput').value = '';
            document.getElementById('portsBtn').disabled = true;
            document.getElementById('clearPortsBtn').disabled = true;
            displayFileName();
            updatePortsStatus();
            document.getElementById('status').style.display = 'none';
            document.getElementById('status').textContent = '';
            document.getElementById('dateError').style.display = 'none';
            document.getElementById('repoDateInput').classList.remove('error');
        }

        document.getElementById('repoDateInput').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4 && value.length <= 6) {
                value = value.slice(0, 4) + '.' + value.slice(4);
            } else if (value.length > 6) {
                value = value.slice(0, 4) + '.' + value.slice(4, 6) + '.' + value.slice(6, 8);
            }
            e.target.value = value;

            const dateError = document.getElementById('dateError');
            const regex = /^\d{4}\.\d{2}\.\d{2}$/;
            if (value === '') {
                e.target.classList.remove('error');
                dateError.style.display = 'none';
            } else if (!regex.test(value)) {
                e.target.classList.add('error');
                dateError.textContent = translations[currentLang].dateFormatError;
                dateError.style.display = 'block';
            } else {
                const [year, month, day] = value.split('.').map(Number);
                const date = new Date(year, month - 1, day);
                if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
                    e.target.classList.add('error');
                    dateError.textContent = translations[currentLang].dateRangeError;
                    dateError.style.display = 'block';
                } else {
                    e.target.classList.remove('error');
                    dateError.style.display = 'none';
                }
            }
        });

        function isValidDateFormat(dateStr) {
            const regex = /^\d{4}\.\d{2}\.\d{2}$/;
            if (!regex.test(dateStr)) return false;
            const [year, month, day] = dateStr.split('.').map(Number);
            const date = new Date(year, month - 1, day);
            return date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day;
        }

        function isValidPortValue(value) {
            return value.length === 5 && /^[A-Z0-9]{5}$/.test(value);
        }

        function insertValues(data, callback) {
            let fromValues = savedPortsData.map(row => row[0]).filter(v => v);
            let toValues = savedPortsData.map(row => row[1]).filter(v => v);
            let newRows = [];

            if (fromValues.length === 0 && toValues.length === 0) {
                callback(data);
                return;
            }

            if (fromValues.length > 0 && toValues.length > 0) {
                toValues.forEach(toValue => {
                    fromValues.forEach(fromValue => {
                        newRows.push([fromValue, toValue]);
                    });
                });
                callback(data.concat(newRows));
                return;
            }

            const uniqueFrom = [...new Set(data.map(row => row[0]).filter(v => v))];
            const uniqueTo = [...new Set(data.map(row => row[1]).filter(v => v))];

            if (fromValues.length === 0) {
                toValues.forEach(toValue => {
                    uniqueFrom.forEach(fromValue => {
                        newRows.push([fromValue, toValue]);
                    });
                });
            } else if (toValues.length === 0) {
                uniqueTo.forEach(toValue => {
                    fromValues.forEach(fromValue => {
                        newRows.push([fromValue, toValue]);
                    });
                });
            }

            callback(data.concat(newRows));
        }

        function processInitialData(callback) {
            const status = document.getElementById('status');
            status.textContent = translations[currentLang].processing;
            status.style.display = 'block';

            if (!uploadedFile) {
                alert(translations[currentLang].noFileAlert);
                status.style.display = 'none';
                return;
            }

            const repoDateValue = document.getElementById('repoDateInput').value.trim();
            if (repoDateValue && !isValidDateFormat(repoDateValue)) {
                alert(translations[currentLang].invalidDateAlert);
                status.style.display = 'none';
                return;
            }

            const reeferInput = document.getElementById('reeferInput').value;
            const reeferValue = reeferInput === 'Y' ? 'Y' : '';

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                
                if (jsonData.length > 3) {
                    jsonData = jsonData.slice(1);
                    jsonData = jsonData.slice(0, -1);
                    jsonData = jsonData.slice(0, -1);
                } else {
                    jsonData = [];
                }
                
                let processed = jsonData.map(row => {
                    const firstColumn = row[0] ? String(row[0]).split('-') : [''];
                    return firstColumn;
                });

                insertValues(processed, (finalData) => {
                    const headerRow = ['From', 'To', 'From Term', 'To Term', 'Reefer', 'Repo Eff Date', 'Case Id', 'SOC'];
                    processedData = [headerRow].concat(finalData);

                    for (let i = 1; i < processedData.length; i++) {
                        if (!processedData[i][0] || processedData[i][0].trim() === '') {
                            break;
                        }
                        processedData[i][2] = processedData[i][2] || 'PIER';
                        processedData[i][3] = processedData[i][3] || 'PIER';
                        processedData[i][4] = processedData[i][4] || reeferValue;
                        processedData[i][5] = processedData[i][5] || repoDateValue;
                    }

                    callback();
                });
            };
            reader.readAsArrayBuffer(uploadedFile);
        }

        function processAndDownload() {
            processInitialData(() => {
                const newWorkbook = XLSX.utils.book_new();
                const newWorksheet = XLSX.utils.aoa_to_sheet(processedData);
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "Processed");
                const outputFileName = `Processed-${uploadedFile.name}`;
                XLSX.writeFile(newWorkbook, outputFileName);
                document.getElementById('status').textContent = `${translations[currentLang].complete}${outputFileName}`;
                document.getElementById('status').style.display = 'block';
            });
        }

        function showFilterModal() {
            processInitialData(() => {
                const fromFilter = document.getElementById('fromFilter');
                const toFilter = document.getElementById('toFilter');
                
                const fromValues = [...new Set(processedData.slice(1).map(row => row[0]).filter(v => v))];
                const toValues = [...new Set(processedData.slice(1).map(row => row[1]).filter(v => v))];

                fromFilter.innerHTML = fromValues.map(val => 
                    `<label><input type="checkbox" name="from" value="${val}" onchange="updateRowCount()"> ${val}</label>`
                ).join('');
                
                toFilter.innerHTML = toValues.map(val => 
                    `<label><input type="checkbox" name="to" value="${val}" onchange="updateRowCount()"> ${val}</label>`
                ).join('');

                document.getElementById('filterModal').style.display = 'block';
                document.getElementById('status').style.display = 'none';
                updateRowCount();
            });
        }

        function showPortsModal() {
            portsData = savedPortsData.map(row => [...row]);
            document.getElementById('portsModal').style.display = 'block';
            document.getElementById('portsFile').value = '';
            displayPortsTable();
            updateSavePortsButtonState();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            updatePortsStatus();
        }

        function loadPortsFile() {
            const file = document.getElementById('portsFile').files[0];
            if (!file) return;

            const hasManualInput = portsData.some(row => row[0] || row[1]);
            if (hasManualInput && !confirm(translations[currentLang].portsUploadOverwriteConfirm)) {
                document.getElementById('portsFile').value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const portsDataArray = new Uint8Array(e.target.result);
                const workbook = XLSX.read(portsDataArray, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                const uploadedPorts = jsonData.slice(1).map(row => [row[0] || '', row[1] || '']);
                
                if (uploadedPorts.length > 30) {
                    alert(translations[currentLang].portsUploadLimitAlert);
                    portsData = uploadedPorts.slice(0, 30);
                } else {
                    portsData = uploadedPorts.concat(Array(30 - uploadedPorts.length).fill().map(() => ['', '']));
                }

                let errorMessage = '';
                portsData.forEach((row, index) => {
                    if (row[0] && !isValidPortValue(row[0])) {
                        errorMessage += translations[currentLang].portsFormatError
                            .replace('{row}', index + 1)
                            .replace('{value}', row[0]) + '\n';
                    }
                    if (row[1] && !isValidPortValue(row[1])) {
                        errorMessage += translations[currentLang].portsFormatError
                            .replace('{row}', index + 1)
                            .replace('{value}', row[1]) + '\n';
                    }
                });
                if (errorMessage) {
                    alert(errorMessage);
                }

                displayPortsTable();
                updateSavePortsButtonState();
            };
            reader.readAsArrayBuffer(file);
        }

        function displayPortsTable() {
            const tbody = document.getElementById('portsTableBody');
            tbody.innerHTML = '';
            for (let i = 0; i < 30; i++) {
                const row = portsData[i] || ['', ''];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="${row[0] && !isValidPortValue(row[0]) ? 'error' : ''}">
                        <input type="text" value="${row[0]}" maxlength="5" oninput="updatePortsData(${i}, 0, this)">
                    </td>
                    <td class="${row[1] && !isValidPortValue(row[1]) ? 'error' : ''}">
                        <input type="text" value="${row[1]}" maxlength="5" oninput="updatePortsData(${i}, 1, this)">
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        function updatePortsData(rowIndex, colIndex, input) {
            let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (value.length > 5) value = value.slice(0, 5);
            input.value = value;
            while (portsData.length <= rowIndex) {
                portsData.push(['', '']);
            }
            portsData[rowIndex][colIndex] = value;
            input.parentElement.className = value && !isValidPortValue(value) ? 'error' : '';
            updateSavePortsButtonState();
        }

        function clearPorts() {
            savedPortsData = Array(30).fill().map(() => ['', '']);
            portsData = Array(30).fill().map(() => ['', '']);
            updatePortsStatus();
        }

        function updateSavePortsButtonState() {
            const saveBtn = document.getElementById('savePortsBtn');
            const hasValues = portsData.some(row => row[0] || row[1]);
            const hasInvalid = portsData.some(row => 
                (row[0] && !isValidPortValue(row[0])) || 
                (row[1] && !isValidPortValue(row[1]))
            );
            saveBtn.disabled = !hasValues || hasInvalid;
            if (hasInvalid) {
                saveBtn.title = translations[currentLang].portsInvalidFormatAlert;
            } else {
                saveBtn.title = '';
            }
        }

        function savePorts() {
            if (portsData.some(row => (row[0] && !isValidPortValue(row[0])) || (row[1] && !isValidPortValue(row[1])))) {
                alert(translations[currentLang].portsInvalidFormatAlert);
                return;
            }
            savedPortsData = portsData.map(row => [...row]);
            closeModal('portsModal');
            updatePortsStatus();
        }

        function updateRowCount() {
            const fromChecked = Array.from(document.querySelectorAll('input[name="from"]:checked')).map(cb => cb.value);
            const toChecked = Array.from(document.querySelectorAll('input[name="to"]:checked')).map(cb => cb.value);

            const filteredRows = processedData.slice(1).filter(row => 
                fromChecked.includes(row[0]) && 
                (toChecked.length === 0 || toChecked.includes(row[1]))
            ).length;

            document.getElementById('rowCount').textContent = `${translations[currentLang].rowCount}${filteredRows}`;
        }

        function clearSelection() {
            document.querySelectorAll('input[name="from"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="to"]').forEach(cb => cb.checked = false);
            updateRowCount();
        }

        function applyFilterAndDownload() {
            processInitialData(() => {
                const fromChecked = Array.from(document.querySelectorAll('input[name="from"]:checked')).map(cb => cb.value);
                const toChecked = Array.from(document.querySelectorAll('input[name="to"]:checked')).map(cb => cb.value);

                if (fromChecked.length === 0) {
                    alert(translations[currentLang].originAlert);
                    return;
                }

                const filteredData = [processedData[0]].concat(
                    processedData.slice(1).filter(row => 
                        fromChecked.includes(row[0]) && 
                        (toChecked.length === 0 || toChecked.includes(row[1]))
                    )
                );

                const rowCount = filteredData.length - 1;
                if (rowCount > 500) {
                    alert(translations[currentLang].rowLimitAlert);
                    return;
                }

                const newWorkbook = XLSX.utils.book_new();
                const newWorksheet = XLSX.utils.aoa_to_sheet(filteredData);
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "Filtered");
                const outputFileName = `Filtered-${uploadedFile.name}`;
                XLSX.writeFile(newWorkbook, outputFileName);
                
                document.getElementById('status').textContent = `${translations[currentLang].complete}${outputFileName}`;
                document.getElementById('status').style.display = 'block';
                closeModal('filterModal');
            });
        }

        changeLanguage();
    </script>
</body>
</html>